import languages from "./languages.js";
import rules from "../rules/index.js";
import "./multiselectlist.js";

const content = {
	template: `
	<div class="outer-container">
		<div class="noprint">
			<h1 class="title">COVID-19 Signage Generator</h1>
			<section aria-labelledby="step1">
				<h2 class="subtitle" id="step1">Step 1: Select languages to include</h2>
				<multiselect-list
						:elements="languages"
						:selected="selectedLanguageKeys"
						keyfield="key"
						id="select-languages">
					<template v-slot:element="{element: language, selected}">
						{{ language.displayName }}
						<span aria-hidden="true" :lang="language.key">&nbsp;({{ language.own }})</span>
					</template>
				</multiselect-list>
			</section>
			<section class="rule-selection" aria-labelledby="step2">
				<h2 class="subtitle" id="step2">Step 2: Select rules to include</h2>
				<multiselect-list
						:elements="rules"
						:selected="selectedRuleNames"
						keyfield="name"
						>
					<template v-slot:element="{element: rule, selected}">
						<img class="icon" :src="'img/icons/' + rule.icon + '.svg'" :class="rule.type" alt=""/>
						<span>{{rule.lang["en"]}}<span>
					</template>
				</multiselect-list>
			</section>
			<section class="rule-selection" aria-labelledby="step3">
				<h2 class="subtitle" id="step3">Step 3: Print this page</h2>
				<button
					@click="window.print()"
					class="button"
					:disabled="!(selectedLanguageKeys.length && selectedRuleNames.length)"
				>Print</button>
			</section>
			<footer class="noprint feedback">
				<a class="button" href="https://github.com/TOPdesk/covid19-signage/issues" target="_blank" rel="noreferrer noopener">Feedback</a>
			</footer>
		</div>
		<section aria-describedby="preview" class="preview">
		<h2 class="subtitle noprint" id="preview">Preview</h2>
		<div class="preview-container">
			<div v-for="(page, index) in pages" class="page">
				<div class="page-number noprint">{{ (index + 1) + '/' + pages.length }}</div>
				<div class="page-content" :class="{'first-page': index === 0}">
					<header class="languages">
						<div v-for="(language, index) in page['languages']" class="language">
							<div :lang="language.key">{{ language.own }}</div>
						</div>
					</header>
					<div v-for="(rule, index) in page['rules']">
						<div class="horizontal-separator" :class="{ 'first-separator': index === 0 }">
							<svg v-if="index !== 0" class="line" viewBox="0 0 100 100" preserveAspectRatio="none" version="1.1" xmlns="http://www.w3.org/2000/svg">
								<defs>
									<linearGradient id="vertical" y1="0" y2="1">
										<stop offset="0%" stop-color="black" />
										<stop offset="50%" stop-color="white" />
										<stop offset="100%" stop-color="black"/>
									</linearGradient>
									<linearGradient id="horizontal">
										<stop offset="0%" stop-color="black" />
										<stop offset="50%" stop-color="white" />
										<stop offset="100%" stop-color="black"/>
									</linearGradient>
									<mask id="_mask">
										<rect width="100" height="100" fill="url(#vertical)"  />
									</mask>
									<mask id="mask">
										<rect width="100" height="100" fill="url(#horizontal)" mask="url(#_mask)"  />
									</mask>
								</defs>
								<rect width="100" height="100" mask="url(#mask)"/>
							</svg>
						</div>
						<div class="rule-container">
							<svg class="rule-background" alt=""
								viewBox="0 0 1 1" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
								<rect width="1" height="1">
							</svg>
							<div class="rule-content">
								<div class="icon-column">
									<div class="icon-holder">
										<svg class="icon-background" :class="rule.type" alt=""
											viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
											<defs>
												<clipPath id="clipPath">
													<rect width="50" height="50" rx="6" />
												</clipPath>
											</defs>
											<rect width="50" height="50" rx="6" clip-path="url(#clipPath)" />
										</svg>
										<img class="icon" :src="'img/icons/' + rule.icon + '.svg'" alt=""/>
									</div>
								</div>
								<div class="translations">
									<div v-for="language in page['languages']" :key="language['key']"
										class="translation-container"
										:lang="language['key']"
										:class="{bigfont: language['bigfont']}"
									>{{rule.lang[language['key']]}}</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="page-break">&nbsp;</div>
				<footer><span>Free multilingual sign, generated by https://www.covid19-signage.org</span></footer>
			</div>
		</div>
		</section>
    </div>`,
	data: () => ({
		selectedLanguageKeys: [],
		selectedRuleNames: [],
		languages,
		rules,
	}),
	computed: {
		selectedRules() {
			return this.rules
				.filter((rule) => this.selectedRuleNames.includes(rule.name))
				.sort((a, b) => this.selectedRuleNames.indexOf(a.name) - this.selectedRuleNames.indexOf(b.name));
		},
		selectedLanguages() {
			return this.languages
				.filter((language) => this.selectedLanguageKeys.includes(language.key))
				.sort((a, b) => this.selectedLanguageKeys.indexOf(a.key) - this.selectedLanguageKeys.indexOf(b.key));
		},
		pages() {
			const distribute = (items, max) => {
				if (!items) {
					return [];
				}
				const copy = [...items];
				if (copy.length <= max) {
					return [copy];
				}
				const buckets = Math.floor((copy.length - 1) / max) + 1;
				const entries = new Array(buckets).fill(0);
				for (let i = 0; i < copy.length; i++) {
					entries[i % buckets]++;
				}
				const result = [];
				entries.forEach((i) => result.push(copy.splice(0, i)));
				return result;
			};

			const pages = [];
			const languageDistribution = distribute(this.selectedLanguages, 4);
			languageDistribution.forEach((pageLanguages) => {
				const ruleDistribution = distribute(this.selectedRules, 4);
				ruleDistribution.forEach((pageRules) => {
					pages.push({
						languages: pageLanguages,
						rules: pageRules,
					});
				});
			});
			return pages;
		},
	},
};

new Vue({
	render: (h) => h(content),
	mounted: () => {
		document.getElementById("select-languages").focus();
	},
}).$mount("#app");
